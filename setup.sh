#!/bin/bash
echo -e "\e[34m
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£†‚†§‚¢æ‚£û‚£ø‚£ø‚£ø‚£∂
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚°§‚†î‚†ö‚†â‚¢Å‚£§‚£∂‚£æ‚£ø‚£ü‚†ª‚¢á‚£ø
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚°§‚†í‚†ã‚†â‚†Ä‚†Ä‚†Ä‚£†‚£∂‚£ø‚£ø‚°ø‚¢ã‚°¥‚†ü‚£æ‚°æ‚†â
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚°¥‚†ö‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚£¥‚£æ‚£ø‚¢ü‚°ø‚¢ã‚°¥‚†õ‚£†‚¢æ‚†è‚†Å‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°¥‚†ö‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£æ‚£ø‚†ø‚°ü‚¢ã‚†î‚¢Å‚£¥‚†ü‚¢Å‚°¥‚£±‚†ã‚†Ä‚†Ä‚†Ä
‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°∂‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°¥‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚£§‚¢∂‚£∂‚£æ‚°ü‚¢†‚†ã‚¢†‚†è‚°∞‚¢ª‚†ã‚°†‚¢ã‚°û‚†Å‚†Ä‚†Ä‚†Ä‚†Ä
‚°è‚¢ß‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚°ø‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°¥‚†ã‚†Ä‚¢Ä‚£∞‚£∂‚£ø‚£∑‚£á‚£æ‚£ø‚¢ø‚£§‚†É‚¢†‚¢è‚°û‚£°‚¢É‚£û‚£°‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚°á‚†à‚†à‚†≥‚¢¶‚°Ä‚†Ä‚†Ä‚¢Ä‚£§‚£†‚£¥‚†ó‚†õ‚†Ä‚¢†‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°¥‚†ã‚†Ä‚†Ä‚£¥‚†ã‚†Å‚£†‚£ø‚£ø‚£ø‚¢ü‚£Ω‚°ø‚¢É‚°¥‚¢É‚†û‚£∞‚£ø‚£ø‚†ü‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚¢ª‚°Ñ‚†Ä‚†Ä‚†∏‚¢ø‚£ø‚°∂‚£æ‚°ç‚†â‚†Å‚†Ä‚†Ä‚£†‚°æ‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°¥‚†ã‚†Ä‚†Ä‚†Ä‚£∏‚†Å‚†Ä‚¢†‚£æ‚£ø‚£Ø‚£ï‚£ø‚£Ø‚†ñ‚¢â‚°¥‚¢ã‚£º‚£Ω‚£µ‚£Ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†à‚¢ø‚£Ü‚°Ä‚†Ä‚¢∫‚£ø‚°á‚†ª‚£ø‚£Ñ‚£Ä‚£§‚°æ‚†õ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚†é‚†Ä‚†Ä‚†Ä‚¢†‚£º‚°á‚†Ä‚†Ä‚†Ä‚†ª‚£Ø‚¢õ‚°µ‚†ö‚¢Å‚°¥‚†ä‚£†‚£æ‚£ø‚£ø‚£ø‚£ø‚£á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†ô‚†ø‚£∂‚£æ‚£ø‚£á‚†Ä‚¢ø‚£ø‚†ü‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£§‚£æ‚†Å‚†Ä‚†Ä‚†Ä‚¢†‚£ø‚£ø‚°á‚†Ä‚†Ä‚†Ä‚¢°‚£ø‚†è‚£Ä‚†î‚¢ã‚°†‚£™‚£ø‚£ø‚£ø‚†ü‚†ª‚†á‚°º‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚¢ª‚°Ñ‚†à‚¢≥‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£∞‚£ø‚£ø‚†á‚†Ä‚†Ä‚£Ä‚£∞‚£ø‚£ø‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚£Ü‚£ø‚°è‚¢Å‚£¥‚£Ø‚°æ‚†ã‚£ø‚£ø‚°Å‚†Ä‚†Ä‚†Ä‚†≥‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢ø‚†Ä‚†Ä‚†ô‚¢¶‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£¥‚£æ‚°ø‚†ã‚†Ä‚¢Ä‚£†‚£∂‚£ø‚£Ø‚°ø‚£ø‚°á‚†Ä‚†Ä‚†Ä‚††‚°Ω‚£∑‚¢û‚£Ω‚°ø‚†ã‚†Ä‚†Ä‚†ò‚£ø‚†ø‚†Ç‚†Ä‚†Ä‚¢∏‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢≥‚°Ä‚†Ä‚¢≤‚£æ‚£ø‚†ì‚†≤‚¢§‚£§‚£§‚†§‚†î‚£≤‚†ü‚†õ‚†ã‚†Å‚¢Ä‚£¥‚£¥‚°ø‚£ø‚£Ω‚£ø‚£ø‚£ø‚£ø‚°Å‚†Ä‚†Ä‚†Ä‚¢∞‚£ª‚°ø‚†ü‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£ß‚†Ä‚†Ä‚†Ä‚£º‚†á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚£¶‚£Ñ‚°ô‚†Å‚†Ä‚†ê‚†ø‚†ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ê‚†ø‚†ø‚¢æ‚£ª‚£¥‚£ø‚£ø‚°ø‚†ø‚†ª‚£ø‚°ø‚†Ä‚†Ä‚†Ä‚†Ä‚£æ‚°ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£á‚†Ä‚£º‚°ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†ô‚¢ø‚£ø‚£∂‚£æ‚£ø‚£∂‚£∂‚£¶‚£§‚£§‚£¥‚£ñ‚£∂‚£æ‚°ø‚†ø‚†õ‚¢â‚£Ä‚£§‚£¥‚£∂‚£ø‚°á‚†Ä‚†Ä‚†Ä‚¢∞‚°ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢π‚¢∞‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†ô‚†ª‚†ø‚¢ø‚£ª‚£ø‚£ø‚£ø‚†õ‚£≠‚£¥‚£í‚£í‚£ö‚£õ‚£Ø‚°≠‚†Ω‚†õ‚†ã‚£ø‚°á‚†Ä‚†Ä‚¢†‚°û‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°ø‚¢†‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚†â‚†â‚†â‚†â‚†â‚†â‚†â‚†Ä‚†Ä‚†Ä  ‚†Ä‚†Ä‚¢ª‚£∑‚†Ä‚¢Ä‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£û‚£Ä‚†è‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä   ‚†∏‚£ø‚£Ä‚£Æ‚°∑‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†∏‚†ø‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä  ‚¢ø‚£ø‚£ª‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä  ‚†ò‚£ø‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä  ‚†ò‚£ø‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
\e[0m"

echo -e "

\033[38;5;214m _____ _     _  __  ____       _               
| ____| |   | |/ / / ___|  ___| |_ _   _ _ __  
|  _| | |   | ' /  \___ \ / _ \ __| | | | '_ \ 
| |___| |___| . \   ___) |  __/ |_| |_| | |_) |
|_____|_____|_|\_\ |____/ \___|\__|\__,_| .__/ 
                                        |_|    \033[0m

\033[1;30;101mAuto ELK Stack setup by Yusuf Kaya\033[0m
\033[1;30;105mVersion: 1.0.1\033[0m

For more info, visit my GitHub, LinkedIn and Medium profiles:
\033[1;36mGitHub: https://github.com/yusufkaya01\033[0m
\033[1;36mLinkedIn: https://www.linkedin.com/in/yusufkayatr96\033[0m
\033[1;36mMedium: https://medium.com/@yusufkayatr96\033[0m

###############################################################
"

echo "Please provide the following values for the .env file:"

# Get values from user and update .env
echo "------------------------------------------------------------------"
read -p "Enter ELASTIC_PASSWORD (at least 6 characters): " ELASTIC_PASSWORD
echo "------------------------------------------------------------------"
read -p "Enter KIBANA_PASSWORD (at least 6 characters): " KIBANA_PASSWORD
echo "------------------------------------------------------------------"
read -p "Enter ENCRYPTION_KEY (random key for encryption or press Enter to generate): " ENCRYPTION_KEY
echo "------------------------------------------------------------------"
read -p "Enter STACK_VERSION (e.g., 8.17.2): " STACK_VERSION
echo "------------------------------------------------------------------"
read -p "Enter CLUSTER_NAME (e.g., my-cluster): " CLUSTER_NAME
echo "------------------------------------------------------------------"
read -p "Enter LICENSE type ('basic' or 'trial', default is 'basic'): " LICENSE
echo "------------------------------------------------------------------"
LICENSE=${LICENSE:-basic}  # Default to 'basic' if no input
read -p "Enter ES_PORT (default 9200): " ES_PORT
echo "------------------------------------------------------------------"
ES_PORT=${ES_PORT:-9200}  # Default to 9200 if empty
read -p "Enter KIBANA_PORT (default 5601): " KIBANA_PORT
echo "------------------------------------------------------------------"
KIBANA_PORT=${KIBANA_PORT:-5601}  # Default to 5601 if empty
echo "------------------------------------------------------------------"



# If no encryption key is provided, generate one using openssl
if [ -z "$ENCRYPTION_KEY" ]; then
  ENCRYPTION_KEY=$(openssl rand -base64 32)
  echo "________________________________________________________________________________________________"
  echo "No encryption key provided. Generated encryption key: $ENCRYPTION_KEY"
  echo "________________________________________________________________________________________________"
fi

# Prompt for Logstash password
read -p "Enter LOGSTASH_PASSWORD (at least 6 characters): " LOGSTASH_PASSWORD
echo "------------------------------------------------------------------"

# Create .env file with the user inputs
echo "************************************************************************************************"
echo "Creating .env file with your inputs... üìù"
sleep 1
cat <<EOL > .env
# Project namespace (defaults to the current folder name if not set)
#COMPOSE_PROJECT_NAME=myproject

# Password for the 'elastic' user (at least 6 characters)
ELASTIC_PASSWORD=${ELASTIC_PASSWORD}

# Password for the 'kibana_system' user (at least 6 characters)
KIBANA_PASSWORD=${KIBANA_PASSWORD}

# Version of Elastic products
STACK_VERSION=${STACK_VERSION}

# Set the cluster name
CLUSTER_NAME=${CLUSTER_NAME}

# Set to 'basic' or 'trial' to automatically start the 30-day trial
LICENSE=${LICENSE}

# Port to expose Elasticsearch HTTP API to the host
ES_PORT=${ES_PORT}

# Port to expose Kibana to the host
KIBANA_PORT=${KIBANA_PORT}

# Increase or decrease based on the available host memory (in bytes)
ES_MEM_LIMIT=4294967296
KB_MEM_LIMIT=1073741824
LS_MEM_LIMIT=1073741824

# SAMPLE Predefined Key only to be used in POC environments
ENCRYPTION_KEY=${ENCRYPTION_KEY}
EOL


echo "************************************************************************************************"
echo ".env file created successfully! üéâ"
echo "************************************************************************************************"

# Replace the password in logstash.conf and other Logstash-related files
echo "************************************************************************************************"
echo "Updating the Logstash configuration file with the new password... üîë"
sleep 1
echo "************************************************************************************************"

# Update the password in logstash.conf
sed -i "s/password => \"<changeme>\"/password => \"${LOGSTASH_PASSWORD}\"/" ./logstash.conf

# No need to modify other files since logstash.conf is enough
echo "Logstash password updated in the logstash.conf file! ‚úÖ"
echo "************************************************************************************************"


# Create directories for persistent volumes
echo "Creating directories for Elasticsearch, Kibana, and Logstash volumes... üõ†Ô∏è"
echo "************************************************************************************************"
sleep 1
mkdir -p ./elasticsearch-volume ./kibana-volume ./logstash-volume

# Set permissions so Docker can read/write
echo "Setting permissions for the volumes... üîí"
echo "************************************************************************************************"
sleep 1
chmod 775 -R ./elasticsearch-volume ./kibana-volume ./logstash-volume

# Start the ELK stack with Docker Compose
echo "Starting ELK stack using Docker Compose... üöÄ"
echo "************************************************************************************************"
sleep 1
docker compose up -d

# Wait for the containers to be healthy
echo "Waiting for all the containers to be healthy... üè•"
for i in {1..90}
do
  echo -n "."
  sleep 1
done
echo " Containers are healthy! ‚úÖ"

# Copy files from the containers to the host machine for persistent volume usage
echo "************************************************************************************************"
echo "Copying Elasticsearch data and config... üì¶"
sleep 1
docker cp elasticsearch:/usr/share/elasticsearch/data ./elasticsearch-volume/
docker cp elasticsearch:/usr/share/elasticsearch/config ./elasticsearch-volume/

echo "________________________________________________________________________________________________"
echo "Copying Kibana data and config... üì¶"
sleep 1
docker cp kibana:/usr/share/kibana/data ./kibana-volume/
docker cp kibana:/usr/share/kibana/config ./kibana-volume/

echo "________________________________________________________________________________________________"
echo "Copying Logstash data, config, and pipeline... üì¶"
sleep 1
docker cp logstash:/usr/share/logstash/data ./logstash-volume/
docker cp logstash:/usr/share/logstash/config ./logstash-volume/
docker cp logstash:/usr/share/logstash/certs ./logstash-volume/

echo "Files copied to volumes successfully! üìÇ‚úÖ"
echo "************************************************************************************************"

# Set permissions for the copied files
echo "Setting permissions for the copied files... üîí"
sleep 1
chmod 775 -R ./elasticsearch-volume ./kibana-volume ./logstash-volume
echo "************************************************************************************************"

# Stop and remove the containers, networks, and volumes
echo "Stopping and removing containers, networks, and volumes... üõë"
sleep 1
docker compose down -v
echo "************************************************************************************************"

# Replace the docker-compose.yml file with the one from ./after-setup
echo "Replacing docker-compose.yml with the one from ./after-setup... üîÑ"
sleep 1
mv ./docker-compose.yml ./compose.old
cp ./after-setup/docker-compose.yml ./docker-compose.yml
echo "################################################################################################"

# Restart the containers with the updated docker-compose.yml
echo "Starting the containers with the updated docker-compose.yml... üîÑ"
sleep 1
docker compose up -d
echo "************************************************************************************************"

# Final message
echo "Process is finished! üéâ"
sleep 1
echo "I thank you for using my repo. Check out my GitHub repo at: https://github.com/yusufkaya01"
echo "Yusuf Kaya"
